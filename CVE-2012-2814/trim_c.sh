#!/bin/bash
# It takes the corpus samples from the corpus directory, makes them unique and minimizes them
# Stores the result in another directory and then replaces the old.
# I made a backup in the unque directory cause this process takes a while.
#
# Just like the rest, running with FIX=1 does the same in the fix directory

if [ -n "$FIX" ];then
	FUZZ_DIR="/fuzz/fix"
else
	FUZZ_DIR="/fuzz"
fi

# Env for the binary
# Make sure to change them for your binary
TARGET_BIN_DIR="$FUZZ_DIR/exif"
BUILD_BIN_DIR="$TARGET_BIN_DIR/install"
TARGET_BIN_BINARY="$BUILD_BIN_DIR/bin/exif"


# Seed/out for our fuzzer
SEEDS="$FUZZ_DIR/corpus"
SEEDS_C="${SEEDS}_c"
SEEDS_U="$FUZZ_DIR/unique_corp"

# AFL env
AFL_DIR="/AFLplusplus"
AFL_CMIN="$AFL_DIR/afl-cmin"
AFL_TMIN="$AFL_DIR/afl-tmin"



	
# Trim the Corpus
echo -e "\nTriming the Corpus\n"

rm -rf "$SEEDS_C"
mkdir "$SEEDS_C"

rm -rf "$SEEDS_U" 
mkdir "$SEEDS_U"

"$AFL_CMIN" -i "$SEEDS" -o "$SEEDS_C" -- "$TARGET_BIN_BINARY" @@
cd "$SEEDS_C"
for i in *;do
	"$AFL_TMIN" -i "$i" -o "$SEEDS_U/$i" -- "$TARGET_BIN_BINARY" @@
done

rm -rf "$SEEDS_C" "$SEEDS" && cp -r "$SEEDS_U" "$SEEDS"
