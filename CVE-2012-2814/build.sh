#!/bin/bash
# Run with the argument UPDATE if you dont wish to downlaod the versions and just want to run the system update for the deps.

# Prep the container
apt update -y && apt install autopoint gettext libpopt-dev tmux screen -y		# Dependancies for the libexif to compile
bash -c "$(wget https://gef.blah.cat/sh -O -)"						# GEF for our gebugging with GDB
apt install python3-pip libssl-dev gdbserver
python3 -m pip install --upgrade pip
python3 -m pip install --upgrade pwntools


FIX_DIR="$PWD/fix/"

# Incase we want to test the fixed versions, otherwise we go on with the vulnerable versions to test
if [ -n "$FIX" ];then
	rm -rf "$FIX_DIR"
	mkdir "$FIX_DIR"
	cd "$FIX_DIR"

	LIB_VERSION="libexif-0_6_21-release"
	BIN_VERSION="exif-0_6_21-release"
else
	LIB_VERSION="libexif-0_6_20-release"
	BIN_VERSION="exif-0_6_20-release"
fi

LIB_TARGET="$LIB_VERSION.tar.gz"
BIN_TARGET="$BIN_VERSION.tar.gz"


if [ "$1" == "UPDATE" ];then
	exit 0
fi


# Setup the lab
rm -rf *exif* corpus*

wget "https://github.com/libexif/libexif/archive/refs/tags/$LIB_TARGET"
tar -xzf libexif*.tar.gz && mv libexif-libexif-* libexif

wget "https://github.com/libexif/exif/archive/refs/tags/$BIN_TARGET"
tar -xzf exif*.tar.gz && mv exif-exif-* exif

git clone https://github.com/ianare/exif-samples
mv exif-samples corpus
cp -r exif-samples corpus
